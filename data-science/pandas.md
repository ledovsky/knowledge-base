# Pandas Notes
Date: 2016-02-25

## Краткое описание 

Библиотека для работы с таблицами данных. Реализует функции, похожие на работу запросов к базе данных - SELECT, GROUP BY, выполнение аггрегирующих функций.

## Загрузка данных

### Чтение и запись CSV файла

[Полная статья в документации](http://pandas.pydata.org/pandas-docs/stable/io.html)

```python
pd.read_csv('path')             # Чтение csv
df.to_csv('path', index=False)  # Запись csv
```

Полезные параметры:

```python
sep=';'                     # Указать разделитель столбцов
decimal='.'                 # Указать разделитель дробной части
thousands=','               # Указать разделитель тысяч
header=None                 # Если нет заголовка
names=['col1', 'col2']      # Указать заголовок, header=None уже не нужно
na_values=['NA#', '###']    # Как распознать NaN, если не работает само
true_values='T'             # Аналогично
false_values='F'            # Аналогично
```

Добавить про работу с датами (когда будет практический кейс)

Как прочитать большой csv файл:

```python
tp = pd.read_csv('file.csv', iterator=True, chunksize=1000) 
df = pd.concat(tp, ignore_index=True)
```

## Подготовка данных

### Удалить дубликаты

Для работы с дубликатами у таблцы pandas есть два метода. Один, `.duplicated`, выдает Series с True/False. Второй, `.drop_duplicates`, предназначен непосредственно для удаления дубликатов (те, что были True в предыдущем методе). Методы принимают одни и те же наборы аргументов.

```python
df.duplicated('col1')               
df.drop_duplicates('col1')                        # Оставляет первое
df.drop_duplicates(['col1', 'col2'])              # По 2-м столбцам
df.drop_duplicates(['col1', 'col2'], keep='last') # Оставляет последнее
df.drop_duplicates(['col1', 'col2'], keep=False)  # Ничего не оставляет
```

### Удалить nan

Nan - not a number. Вариантов удалить строки с пропусками довольно много.

```python
np.isnan(x)                         # Проврить, является ли число nan
df = df[pd.notnull(df['col1'])]     # Удалить строки, где в col1 nan
df.dropna()                         # Удалить строку, если в ней есть nan
df.dropna(subset=['col1', 'col2'])  # Удалить, если nan в col1 или col2
df.dropna(how='all')                # Удалить, только если вся строка nan
df.dropna(subset=['col1', 'col2'], how='all')
```

### Переименование и удаление столбцы

```python
df.rename(columns={df.columns[0]: 'new_name'}, inplace=True)
del df.A
del df['A']
```

## Выбор данных

Pandas приводит для выбора и разделения таблиц данных очень большое количество методов. В данном разделе собранны наиболее необходимые.

### Доступ к столбцам

```python
df['A']         # Выбрать столбец A
df.A            # Выбрать столбец A
df[u'Б']        # Выбрать столбец Б, для русских колонок
df[['A', 'B']]  # Выбрать несколько столбцов
```

### Выбор строк по условию

[Ссылка на документацию](http://pandas.pydata.org/pandas-docs/stable/indexing.html#boolean-indexing)

Наверное, самый главный способ выбора и разделения данных. Синтакс заключается в указании в квадратных скобках условия. Условие должно быть списком или массивом длинной в количество строк.

```python
df[condition]
```

Простые варианты условий выглядят в виде логических выражений.

```python
df[df.A == 'one']
df[df.A == 'one' & df.B > 10]
df[df.B > 5 | df.B > 10]
```

Более сложные можно сделать с помощью функции map.

```python
criterion = df2['B'].map(lambda x: x.startswith('t'))
df[criterion]
df[criterion & df.A == 'one']
```

Для использования в качестве критерия множества дискретных значений можно использовать `.isin`, который применяется к Series.

```python
df[df.A.isin(['one', 'two', 'tree'])]
```

### Выбор строк по номерам

Выбрать строки по номерам возможно, указав индексы в квадратных скобках. Необходимо отметить, что, как и в обычном Python, последний индекс не включается.

```python
df[1]     # Первая строка
df[1:3]   # От первой до второй 
df[:3]    # От начала (нулевой строки) до второй
df[5:]    # От 5 до конца
df[::-1]  # Все в обратном порядке
df[::2]   # Каждую вторую строку
```

Для доступа к DataFrame, как к матрице, используется метод `.iloc`. В простых случаях он работает, как обычные квадратные скобки из предыдущего примера. Но также позволяет выбрать элемент по двум индексам

```python
df.iloc[:,1:3]
df.iloc[4,3]
```

### Выбор случайных строк

Для выбора случайных строк используется функция  `sample`, которая применяется как для DataFrame, так и для Series.

```python
s.sample()          # Выбирает 1 случайную строку
s.sample(n=4)       # Выбирает 4 строки
s.sample(frac=0.2)  # Выбирает 20% строк
```

### Выбор строк по индексу

Использование индексов становится актуальным для сводных таблиц.

По умолчанию индекс определяется как arrange(n), где n - количество строк. Индекс может быть назначен одним из столбцов. Также возможен множественный индекс по нескольким столбцам.

```python
df.set_index('A')           # Сделать индексом столбец 'A'
df.set_index(['A', 'B'])    # Сделать индексом столбцы 'A' и 'B'
```

Выбор по индексу осуществляется функцией `.loc`. При этом возможно также выбирать промежутки

```python
df.loc['a']
df.loc['a':'f']
df.loc['f':]
df.loc['f']
```

### Получение уникальных значений

    :::python
    

## Анализ данных

### Перекрестная таблица (cross tabulation)

Подходит для анализа категорийных переменных. По горизонтали перекрестной таблицы значения одной переменной, по вертикали другой переменной, в ячейках количество пересечений.

[Ссылка на документацию](http://pandas.pydata.org/pandas-docs/stable/reshaping.html#cross-tabulations)

## Полезные на всех этапах методы

### Получение размерности и названий столбцов

Для получения размерности DataFrame и Series используется функция `shape` (как и в Numpy)

```python
df.shape            # Размерность
df.shape[0]         # Количество строк
```

Получение названий столбцов

```python
df.columns.values   # Перечень названий столбцов
df.columns[0]       # Название столбца
```

### Применение функций к таблице: map, apply, applymap

* `.map` применяет функцию к Series и возвращает Series такого же размера
* `.apply` применяет функцию к DataFrame и возвращает Series
* `.applymap` применяет функцию к DataFrame и возвращает DataFrame такого же размера

### Создание таблиц, в том числе со случайными данными

```python
d = {'col1': ts1, 'col2': ts2}
df = pd.DataFrame(data=d, index=index)
df2 = pd.DataFrame(np.random.randn(10, 5)) 

headers = ['var1', 'var2']
rows = [[1, 2], [1, 3]]
df3 = pd.DataFrame(rows, columns=headers)
```
## Ссылки 

* [Документация](http://pandas.pydata.org/pandas-docs/stable/index.html)
* [Статья по полезным функциям](http://dataconomy.com/14-best-python-pandas-features/)



    



